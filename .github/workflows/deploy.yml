name: Deploy Scraper

on:
  workflow_dispatch:
    inputs:
      scraper:
        description: "Scraper to deploy"
        required: true
        type: choice
        options:
          - tubescraper
          - tokscraper
          - instascraper
      tag:
        description: "Git tag (e.g. tubescraper/v0.0.5). Leave empty to deploy the latest production release."
        required: false
        type: string

env:
  REGISTRY: europe-west4-docker.pkg.dev/pas-shared/pas

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve tag and determine environment
        id: config
        run: |
          TAG="${{ inputs.tag }}"

          if [ -z "$TAG" ]; then
            TAG=$(git tag -l "${{ inputs.scraper }}/v*" | grep -v -- '-' | sort -V | tail -1)
            if [ -z "$TAG" ]; then
              echo "::error::No production release found for ${{ inputs.scraper }}"
              exit 1
            fi
            echo "No tag specified, using latest production release: $TAG"
          fi

          VERSION="${TAG#${{ inputs.scraper }}/}"

          if [ "$VERSION" = "$TAG" ]; then
            echo "::error::Tag '$TAG' does not match scraper '${{ inputs.scraper }}'. Expected format: ${{ inputs.scraper }}/vX.Y.Z"
            exit 1
          fi

          if [[ "$VERSION" == *-* ]]; then
            echo "environment=dev" >> "$GITHUB_OUTPUT"
            echo "gcp_project=pas-development-1" >> "$GITHUB_OUTPUT"
            echo "cluster=dev-cluster" >> "$GITHUB_OUTPUT"
          else
            echo "environment=prod" >> "$GITHUB_OUTPUT"
            echo "gcp_project=pas-production-1" >> "$GITHUB_OUTPUT"
            echo "cluster=prod-cluster" >> "$GITHUB_OUTPUT"
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Print deploy details
        run: |
          echo "Scraper:     ${{ inputs.scraper }}"
          echo "Version:     ${{ steps.config.outputs.version }}"
          echo "Image:       ${{ env.REGISTRY }}/${{ inputs.scraper }}:${{ steps.config.outputs.version }}"
          echo "Environment: ${{ steps.config.outputs.environment }}"
          echo "Cluster:     ${{ steps.config.outputs.cluster }}"
          echo "Project:     ${{ steps.config.outputs.gcp_project }}"

      - name: Update kustomize image tag
        run: |
          cd deployments/${{ steps.config.outputs.environment }}
          kustomize edit set image \
            ${{ env.REGISTRY }}/${{ inputs.scraper }}:${{ steps.config.outputs.version }}

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          token_format: access_token
          project_id: ${{ steps.config.outputs.gcp_project }}
          workload_identity_provider: projects/1086645519617/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider
          service_account: github-actions-service-account@pas-shared.iam.gserviceaccount.com
          access_token_lifetime: 600s

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ steps.config.outputs.cluster }}
          location: europe-west4-b
          project_id: ${{ steps.config.outputs.gcp_project }}

      - name: Deploy
        run: kubectl apply -k deployments/${{ steps.config.outputs.environment }}
